#! /bin/bash

# this script updates the most commonly used shell initialization files
# to add the PATH to the supervp application

initpath="$HOME/Library/Application Support/Ircam"
scriptpath=`dirname "$0"`

# If we are in a .app folder go to the top level
if [ "`expr \"$scriptpath\" : \"\(.*\)/[^/]*[.]app/Contents/MacOS$\" `" != "" ]; then
scriptpath="`expr \"$scriptpath\" : \"\(.*\)/[^/]*[.]app/Contents/MacOS$\" `"
fi

# run the command to provoke the authentication dialog.
`readlink $scriptpath/supervp`

mkdir -p "$initpath"

cat  > "$initpath/supervp_init_rc.sh" <<EOF
# Do not edit, automatically generated from supervp_init.sh
PAMAT1=\`expr "\$PATH" :  "$scriptpath:"\`
PAMAT2=\`expr "\$PATH" :  ".*:$scriptpath\$"\`
PAMAT3=\`expr "\$PATH" :  ".*:$scriptpath:"\`
if [ "\$PAMAT1" = "0" -a "\$PAMAT2" = "0"  -a "\$PAMAT3" = "0" ]; then
export PATH="$scriptpath:\$PATH" 
fi
EOF
chmod u+x "$initpath/supervp_init_rc.sh"

echo updated "$initpath/supervp_init_rc.sh"

cat > "$initpath/supervp_init_rc.csh" <<EOF
# Do not edit, automatically generated from supervp_init.sh
set PAMAT1=\`expr "\$PATH" :  "$scriptpath\:"\`
set PAMAT2=\`expr "\$PATH" :  ".*\:$scriptpath"'$'\`
set PAMAT3=\`expr "\$PATH" :  ".*\:$scriptpath\:"\`
if ( "\$PAMAT1"  == "0" &&  "\$PAMAT2"  == "0" && "\$PAMAT3"  == "0" ) then
setenv PATH "$scriptpath":"\$PATH" 
endif
EOF

chmod u+x "$initpath/supervp_init_rc.csh"

echo updated "$initpath/supervp_init_rc.csh"

# update .cshrc
found=0;

function updatercfile {

    rcfile=$1;
    ext=$2
    action=$3

    if ! fgrep -q "source \"$initpath/supervp_init_rc.$ext\"" $rcfile 2>/dev/null ; then
        echo  >> $rcfile
       echo "# init supervp environment " >> $rcfile
        echo "test -f \"$initpath/supervp_init_rc.$ext\" && source \"$initpath/supervp_init_rc.$ext\"" >> $rcfile
        echo "$action in $rcfile"
    else
        echo $rcfile is up to date.
    fi
}

if [ -f  $HOME/.tcshrc ]; then
    updatercfile $HOME/.tcshrc csh update
    found=1
else
    if [ -f  $HOME/.cshrc ]; then
        updatercfile $HOME/.cshrc csh update
        found=1
    fi
fi

if [ $found = 0 ];then
    updatercfile $HOME/.tcshrc csh create
    chown $USER $HOME/.tcshrc
fi

updatercfile $HOME/.bashrc sh update
chown $USER $HOME/.bashrc

found=0;
if [ -f  $HOME/.bash_profile ]; then
    updatercfile $HOME/.bash_profile sh update
    found=1
else
    if [ -f  $HOME/.bash_login ]; then
        updatercfile $HOME/.bash_login sh update
        found=1
    else
        if [ -f  $HOME/.profile ]; then
            updatercfile $HOME/.profile sh update
            found=1
        fi
    fi
fi

if [ $found = 0 ];then
    updatercfile $HOME/.bash_profile sh create
    chown $USER $HOME/.bash_profile
fi

if [ -z ${ZDOTDIR+x} ]; then
    usezdir=$HOME
else
    usezdir=$ZDOTDIR
fi

if [ -f $usezdir/.zshrc ]; then
    updatercfile $usezdir/.zshrc sh update
else
    updatercfile $usezdir/.zshrc sh create
fi

osascript -e " tell application \"Finder\" to display dialog \"Shell configuration updated to use $scriptpath\" "
#osascript -e 'tell application "Terminal" to close the first window '
